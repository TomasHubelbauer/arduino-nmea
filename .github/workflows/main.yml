name: ci
on: push
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
    - name: Check out the source code
      uses: actions/checkout@v1
    - name: Compile the sketch # TODO: Figure out how to get the HEX from this
      uses: arduino/compile-sketches@v1 # https://github.com/arduino/compile-sketches
      with:
        sketch-paths: |
          - .
        cli-compile-flags: |
          - --build-path .
    - name: Install Arduino CLI
      uses: arduino/setup-arduino-cli@v1.1.1 # https://github.com/arduino/setup-arduino-cli
    - name: Validate expected output
      run: |
        ls /tmp/arduino-sketch-*
        cp /tmp/arduino-sketch-*/arduino-nmea.ino.hex arduino-nmea.hex
        ls
        set -e
        set -x
        # Update index, install the AVR core and compile the sketch (into ELF and HEX) for the Uno
        arduino-cli core update-index
        arduino-cli core install arduino:avr
        
        # TODO: Replace with the HEX from the "Compile the sketch" step if possible
        # https://github.com/arduino/compile-sketches/issues/25
        arduino-cli compile -b arduino:avr:uno nmea-checksum
        # Check if the produced file matches the expected file
        diff nmea-checksum.uart nmea-checksum.uart.check
